name: On commits to main

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

concurrency:
  # Cancel any running workflow when new commits are pushed to main.
  group: on-commits-to-main
  cancel-in-progress: true

jobs:
  build-dev-image:
    name: Build Dev Docker Image
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/build-dockerhub-image.yml
    with:
      image_directory: platform
      image_name: platform
      version: dev
      push_image: true
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  deploy-to-staging:
    name: Deploy to staging
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: build-dev-image
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2.1.7
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials archestra-staging \
            --zone us-central1-a \
            --project friendly-path-465518-r6

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: "latest"

      - name: Deploy to staging
        run: |
          helm upgrade archestra-platform \
            helm \
            --install \
            --namespace archestra \
            --create-namespace \
            --set archestra.image=archestra/platform:dev \
            --set archestra.databaseUrl="${{ secrets.ARCHESTRA_STAGING_DATABASE_URL }}" \
            --wait
