suite: test archestra platform -- Deployment/Service
templates:
  - archestra-platform.yaml
tests:
  - it: should create a Service with correct metadata
    documentIndex: 0
    asserts:
      - isKind:
          of: Service
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform$

  - it: should be ClusterIP type
    documentIndex: 0
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should expose backend port 9000
    documentIndex: 0
    asserts:
      - contains:
          path: spec.ports
          content:
            name: backend
            port: 9000
            targetPort: backend
            protocol: TCP

  - it: should expose frontend port 3000
    documentIndex: 0
    asserts:
      - contains:
          path: spec.ports
          content:
            name: frontend
            port: 3000
            targetPort: frontend
            protocol: TCP

  - it: should create a Deployment with correct metadata
    documentIndex: 1
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform$
      - equal:
          path: spec.replicas
          value: 1

  - it: should configure container with correct image
    documentIndex: 1
    set:
      archestra.image: archestra/platform:test-version
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: archestra/platform:test-version

  - it: should expose both backend and frontend ports
    documentIndex: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: backend
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 9000
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: frontend
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 3000

  - it: should set DATABASE_URL to internal postgres when external_database_url is null
    documentIndex: 1
    set:
      postgresql.external_database_url: null
      postgresql.auth.username: testuser
      postgresql.auth.password: testpass
      postgresql.auth.database: testdb
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: DATABASE_URL
      - matchRegex:
          path: spec.template.spec.containers[0].env[0].value
          pattern: ^postgresql://testuser:testpass@.*-archestra-platform-postgresql:5432/testdb$

  - it: should set DATABASE_URL to external postgres when external_database_url is provided
    documentIndex: 1
    set:
      postgresql.external_database_url: postgresql://external:pass@external-host:5432/externaldb
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: DATABASE_URL
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: postgresql://external:pass@external-host:5432/externaldb

  - it: should have init container to wait for PostgreSQL
    documentIndex: 1
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-postgres
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:1.36

  - it: should configure init container to wait for internal postgres
    documentIndex: 1
    set:
      postgresql.external_database_url: null
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[0].command[2]
          pattern: ".*-archestra-platform-postgresql.*5432.*"

  - it: should configure init container to wait for external postgres
    documentIndex: 1
    set:
      postgresql.external_database_url: postgresql://user:pass@external-db.example.com:5432/mydb
    asserts:
      - matchRegex:
          path: spec.template.spec.initContainers[0].command[2]
          pattern: ".*external-db.example.com.*5432.*"

  - it: when archestra.env is empty should set a specific set of environment variables
    documentIndex: 1
    set:
      archestra.env: {}
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: DATABASE_URL
              value: postgresql://archestra:archestra_dev_password@RELEASE-NAME-archestra-platform-postgresql:5432/archestra_dev
            - name: K8S_NAMESPACE
              value: NAMESPACE
            - name: USE_IN_CLUSTER_KUBECONFIG
              value: "true"

  - it: should add custom environment variables when archestra.env is set
    documentIndex: 1
    set:
      archestra.env:
        ARCHESTRA_API_BASE_URL: "https://api.example.com"
        CUSTOM_VAR: "custom-value"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_API_BASE_URL
            value: "https://api.example.com"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: "custom-value"

  - it: should include DATABASE_URL alongside custom env vars
    documentIndex: 1
    set:
      archestra.env:
        ARCHESTRA_API_BASE_URL: "https://api.example.com"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_URL
            value: postgresql://archestra:archestra_dev_password@RELEASE-NAME-archestra-platform-postgresql:5432/archestra_dev
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_API_BASE_URL
            value: "https://api.example.com"

  - it: should set K8S_NAMESPACE env var when namespace is configured
    documentIndex: 1
    set:
      archestra.kubernetes.namespace: "mcp-servers"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: K8S_NAMESPACE
            value: "mcp-servers"

  - it: should use custom namespace over release namespace when both are set
    documentIndex: 1
    set:
      archestra.kubernetes.namespace: "custom-mcp-namespace"
    release:
      namespace: "release-namespace"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: K8S_NAMESPACE
            value: "custom-mcp-namespace"

  - it: should set MCP_SERVER_BASE_IMAGE env var when baseImage is configured
    documentIndex: 1
    set:
      archestra.kubernetes.baseImage: "my-registry/mcp-server:v1.0.0"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MCP_SERVER_BASE_IMAGE
            value: "my-registry/mcp-server:v1.0.0"

  - it: should set K8S_NAMESPACE to release namespace when namespace is empty
    documentIndex: 1
    set:
      archestra.kubernetes.namespace: ""
    release:
      namespace: "test-namespace"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: K8S_NAMESPACE
            value: "test-namespace"

  - it: should set K8S_NAMESPACE to NAMESPACE when namespace is empty and no release namespace
    documentIndex: 1
    set:
      archestra.kubernetes.namespace: ""
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: K8S_NAMESPACE
            value: "NAMESPACE"

  - it: should not set MCP_SERVER_BASE_IMAGE env var when baseImage is empty
    documentIndex: 1
    set:
      archestra.kubernetes.baseImage: ""
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: MCP_SERVER_BASE_IMAGE

  # Kubeconfig volume mount tests
  - it: should not mount kubeconfig volume when kubeconfig is disabled
    documentIndex: 1
    set:
      archestra.kubernetes.kubeconfig.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].volumeMounts
      - isNull:
          path: spec.template.spec.volumes

  - it: should not mount kubeconfig volume when secretName is empty
    documentIndex: 1
    set:
      archestra.kubernetes.kubeconfig.enabled: true
      archestra.kubernetes.kubeconfig.secretName: ""
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].volumeMounts
      - isNull:
          path: spec.template.spec.volumes

  - it: should mount kubeconfig volume when kubeconfig is enabled
    documentIndex: 1
    set:
      archestra.kubernetes.kubeconfig.enabled: true
      archestra.kubernetes.kubeconfig.secretName: "my-kubeconfig"
      archestra.kubernetes.kubeconfig.mountPath: "/etc/kubeconfig"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: kubeconfig
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: "/etc/kubeconfig"
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].readOnly
          value: true

  - it: should create volume from secret when kubeconfig is enabled
    documentIndex: 1
    set:
      archestra.kubernetes.kubeconfig.enabled: true
      archestra.kubernetes.kubeconfig.secretName: "my-kubeconfig"
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].name
          value: kubeconfig
      - equal:
          path: spec.template.spec.volumes[0].secret.secretName
          value: "my-kubeconfig"

  - it: should set KUBECONFIG env var when kubeconfig volume is mounted
    documentIndex: 1
    set:
      archestra.kubernetes.kubeconfig.enabled: true
      archestra.kubernetes.kubeconfig.secretName: "my-kubeconfig"
      archestra.kubernetes.kubeconfig.mountPath: "/etc/kubeconfig"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: KUBECONFIG
            value: "/etc/kubeconfig/config"

  - it: should not set KUBECONFIG env var when kubeconfig is disabled
    documentIndex: 1
    set:
      archestra.kubernetes.kubeconfig.enabled: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: KUBECONFIG

  - it: should configure all kubernetes env vars when all settings are provided
    documentIndex: 1
    set:
      archestra.kubernetes.namespace: "mcp-servers"
      archestra.kubernetes.baseImage: "my-registry/mcp-server:v1.0.0"
      archestra.kubernetes.kubeconfig.enabled: true
      archestra.kubernetes.kubeconfig.secretName: "my-kubeconfig"
      archestra.kubernetes.kubeconfig.mountPath: "/etc/kubeconfig"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: K8S_NAMESPACE
            value: "mcp-servers"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MCP_SERVER_BASE_IMAGE
            value: "my-registry/mcp-server:v1.0.0"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: KUBECONFIG
            value: "/etc/kubeconfig/config"

  - it: should set USE_IN_CLUSTER_KUBECONFIG to false when configured
    documentIndex: 1
    set:
      archestra.kubernetes.useInClusterConfig: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: USE_IN_CLUSTER_KUBECONFIG
            value: "false"

  - it: should set USE_IN_CLUSTER_KUBECONFIG to true when configured
    documentIndex: 1
    set:
      archestra.kubernetes.useInClusterConfig: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: USE_IN_CLUSTER_KUBECONFIG
            value: "true"

  # ServiceAccount tests
  - it: should use default ServiceAccount name when serviceAccount.create is true
    documentIndex: 1
    set:
      serviceAccount.create: true
    asserts:
      - matchRegex:
          path: spec.template.spec.serviceAccountName
          pattern: -archestra-platform$

  - it: should use custom ServiceAccount name when provided
    documentIndex: 1
    set:
      serviceAccount.create: true
      serviceAccount.name: "custom-sa-name"
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: "custom-sa-name"

  - it: should use default ServiceAccount when serviceAccount.create is false
    documentIndex: 1
    set:
      serviceAccount.create: false
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: "default"

  - it: should use custom ServiceAccount name even when create is false
    documentIndex: 1
    set:
      serviceAccount.create: false
      serviceAccount.name: "existing-sa-name"
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: "existing-sa-name"

  # ImagePullSecrets tests
  - it: should not have imagePullSecrets when not configured
    documentIndex: 1
    asserts:
      - isNull:
          path: spec.template.spec.imagePullSecrets

  - it: should add imagePullSecrets to pod when configured
    documentIndex: 1
    set:
      imagePullSecrets:
        - name: myregistrykey
        - name: anotherregistrykey
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: myregistrykey
      - equal:
          path: spec.template.spec.imagePullSecrets[1].name
          value: anotherregistrykey

  # Integration test with ServiceAccount and imagePullSecrets
  - it: should configure both ServiceAccount and imagePullSecrets
    documentIndex: 1
    set:
      serviceAccount.create: true
      serviceAccount.name: "custom-archestra-sa"
      imagePullSecrets:
        - name: private-registry-secret
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: "custom-archestra-sa"
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: private-registry-secret
